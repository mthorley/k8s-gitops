apiVersion: v1
kind: ConfigMap
metadata:
  name: mqtt-bootstrap
  namespace: mqtt
  labels:
    app.kubernetes.io/name: mosquitto
    app.kubernetes.io/instance: mqtt
  annotations:
    kustomize.toolkit.fluxcd.io/substitute: disabled
data:
  bootstrap.sh: |
    #!/bin/sh

    touch /mosquitto/data/users.txt
    OLDIFS=$IFS;IFS=:
    i=0
    for token in $MQTT_CREDS; do
        if [[ $i = 0 ]]; then
            user=$(echo ${token})
            i=i+1
        else
            pwd=$(echo ${token})
            mosquitto_passwd -b /mosquitto/data/users.txt $user $pwd
            i=0
        fi
    done
